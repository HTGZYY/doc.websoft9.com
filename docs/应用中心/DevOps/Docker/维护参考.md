---
sidebar_position: 2
slug: /docker/admin
tags:
  - Docker
  - DevOps
---

# 维护参考


## 系统参数

Docker 预装包包含 Docker 运行所需一序列支撑软件（简称为“组件”），下面列出主要组件名称、安装路径、配置文件地址、端口、版本等重要的信息。

### 路径

#### Docker

Docker 根目录: */var/lib/docker*  
Docker 镜像目录: */var/lib/docker/image*   
Docker daemon.json 文件：默认没有创建，请到 */etc/docker* 目录下根据需要自行创建   

#### Portainer

Portainer 数据卷：*/var/lib/docker/volumes/portainer_data/_data* 


### 端口号

在云服务器中，通过 **[安全组设置](https://support.websoft9.com/docs/faq/zh/tech-instance.html)** 来控制（开启或关闭）端口是否可以被外部访问。 

本应用建议开启的端口如下：

| 名称 | 端口号 | 用途 |  必要性 |
| --- | --- | --- | --- |
| Portainer | 9000 | 通过 HTTP 访问 Portainer | 必须 |

### 版本号

组件版本号可以通过云市场商品页面查看。但部署到您的服务器之后，组件会自动进行更新导致版本号有一定的变化，故精准的版本号请通过在服务器上运行命令查看：

```shell
# Check all components version
sudo cat /data/logs/install_version.txt

# Linux Version
lsb_release -a

# Docker Version
docker -v
```

### 服务

使用由 Websoft9 提供的 Docker 部署方案，可能需要用到的服务如下：

#### Docker系统服务

```shell
sudo systemctl start docker
sudo systemctl restart docker
sudo systemctl stop docker
sudo systemctl status docker
```

#### Docker-compose服务

```
#创建容器编排
sudo docker-compose up

#创建容器编排并重建有变化的容器
sudo docker-compose up -d

#启动/重启
sudo docker-compose start
sudo docker-compose stop
sudo docker-compose restart
```

#### 运行时容器管理

> 终止命令 `stop` 会从进程中释放容器的资源，但不会删除容器

```shell
#示例：mysql
sudo docker pause mysql
sudo docker stop mysql

#示例：redis
sudo docker pause redis
sudo docker stop redis
```


## 备份

Docker上的应用备份主要通过**下载Volume**实现最小化的备份方案。

下面以列表的方式介绍这种备份：
```
- 备份范围: 数据库和应用程序
- 备份效果: 一般
- 备份频率: 一周最低1次，备份保留30天
- 恢复方式: 重新导入
- 技能要求：非常容易
- 自动化：无
```
通用的手动备份操作步骤如下：

1. 通过 WinSCP 将Volume目录**压缩后**再完整的下载到本地
2. 如果涉及数据库，建议导出 SQL 文件
3. 将程序文件、数据文件和数据库文件放到同一个文件夹，根据日期命名
4. 备份工作完成

## 恢复

## 升级

Docker 完整的更新升级包括：系统级更新（操作系统和运行环境）和 Docker 程序升级两种类型

### 系统级更新

运行一条更新命令，即可完成系统级更新：

``` shell
#For Ubuntu&Debian
apt update && apt upgrade -y

#For Centos&Redhat
yum update -y
```
> 本部署包已预配置一个用于自动更新的计划任务。如果希望去掉自动更新，请删除对应的Cron

### Docker 更新升级

上面的命令会同时升级 Docker 程序本体

#### 容器升级

#### Docker 命令升级

以正在运行的 MySQL 容器为例，如果没有持久化卷，容器的升级步骤：

```
#更新镜像
docker pull mysql

#停止容器
docker stop my-mysql-container

#删除容器
docker rm my-mysql-container

#重载容器
docker run --name=my-mysql-container --restart=always \
  -e MYSQL_ROOT_PASSWORD=mypwd -v /my/data/dir:/var/lib/mysql -d mysql
```

#### Docker-Compose 命令升级

如果使用的是 Docker-Compose 启动的容器，升级容器只需运行如下三条命令：

```
docker-compose down -v
docker-compose pull
docker-compose up -d
```


## 故障处理

我们收集使用 Docker 过程中最常见的故障，供您参考：

#### 单台服务器上是否可以跑多个容器？

只要服务器资源允许，单台服务器上可以运行成百上千个容器

#### 什么是Docker的C/S模式？

Docker安装后，在宿主机（服务器）端会运行一个 Docker Daemon 守护进程，同时也安装一个Docker客户端与这个守护进程通信。但客户端与守护进程是分离的，即可以在任何地方运行客户端，然后通过远程与守护进程通信。
![](https://libs.websoft9.com/Websoft9/DocsPicture/zh/docker/docker-cs-websoft9.png)

#### 是否可以通过SSH连接容器？

在Container上的 console 控制台可以很方便的使用命令操作
![](https://libs.websoft9.com/Websoft9/DocsPicture/zh/docker/portainer/portainer-console-websoft9.png)

#### 一个容器中可以运行多个应用吗？

可以。但是从微服务架构角度看，建议一个容器运行单个应用或单个进程

#### 容器中的服务是否可以被互联网访问？

通过与宿主机（服务器）进行端口映射，实现被互联网用户访问

#### 是否有可视化的 Docker 管理工具？

有，推荐使用 Portainer

#### 是否可以修改 Docker 根目录？

可以，但不建议修改

#### Docker service 无法启动？

先通过 `systemctl status docker` 和 `journalctl -xe` 查看错误日志。

* 如果错误日志是  Unit docker.socket entered failed state，表明系统缺少 docker 用户组，运行 `groupadd docker` 增加用户组

#### 容器无法启动？

最常见的原因是用户没有按照该容器的要求，设置必须的环境变量，导致容器启动失败

```shell
#查看容器日志，name是容器名称
sudo docker logs name
```

#### 容器端口映射失败？

如果用户无法把握宿主机（服务器）操作系统端口与容器端口的映射关系、可用性情况，请开启端口自动映射

#### MySQL 容器无法远程访问？

导致这个问题的可能原因有三点：

1. 端口映射设置错误，导致容器没有网络
2. 容器没有开启远程访问权限
3. MySQL 8.0 特殊设置要求
